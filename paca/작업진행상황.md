# P-ACA 프로젝트 진행 상황

## 📅 작업 일시
2025-11-23

## ✅ 완료된 작업

### 1. 사전 조사 및 분석
- [x] **4대보험 계산 로직 분석** (`docs/i-max-4대보험분석.md`)
  - c:/projects/i-max 프로젝트의 4대보험 계산 로직 완전 분석
  - 국민연금, 건강보험, 장기요양보험, 고용보험, 산재보험 계산식 문서화
  - 근로자/사업주 부담금 계산 방법 정리

- [x] **시즌 전환 로직 상세 분석** (`docs/시즌전환로직분석.md`)
  - 월회비 → 시즌비 전환 시나리오 분석
  - 일할 계산 알고리즘 설계
  - 환불 계산 로직 정의
  - 테스트 케이스 4개 작성

### 2. 데이터베이스 설계
- [x] **MySQL 스키마 완성**
  - `database/schema.sql` - 초기 버전
  - `database/schema-fixed.sql` - 수정 버전 (예약어 문제 해결)
  - `database/salary_records_fix.sql` - 최종 수정 버전

#### 생성된 테이블 (총 19개)
1. `users` - 사용자 계정 (원장/관리자/선생님)
2. `academies` - 학원 기본 정보
3. `academy_settings` - 학원 운영 설정
4. `students` - 학생 정보
5. `student_performance` - 학생 성적/실기 기록
6. `instructors` - 강사 정보
7. `instructor_attendance` - 강사 출퇴근 기록
8. `salary_records` - 급여 지급 기록 ⭐
9. `class_schedules` - 수업 일정
10. `attendance` - 출결 관리
11. `season_settings` - 시즌 설정
12. `student_seasons` - 학생 시즌 등록
13. `student_payments` - 수강료 납부 기록
14. `revenues` - 수입 기록
15. `expenses` - 지출 기록
16. `notifications` - 알림 기록
17. `audit_logs` - 감사 로그
18. `holidays` - 공휴일 관리
19. `views` - 3개 뷰 (미납자 조회, 월별 매출, 강사 급여)

### 3. 백엔드 프로젝트 구조
- [x] **Express 백엔드 초기화**
  - `backend/package.json` - 의존성 설정
  - `backend/server.js` - 메인 서버 파일
  - `backend/config/database.js` - MySQL 연결 풀 설정
  - `backend/middleware/auth.js` - JWT 인증 미들웨어
  - `backend/.env.example` - 환경 변수 템플릿

#### 라우트 파일
- [x] `routes/auth.js` - **완료** (회원가입, 로그인, 비밀번호 변경)
- [x] `routes/users.js` - **완료** (사용자 목록, 승인/거부, 사용자 조회)
- [x] `routes/students.js` - **완료** (학생 CRUD, 검색, 성적/납부 기록 조회)
- [x] `routes/instructors.js` - **완료** (강사 CRUD, 출퇴근 기록, 급여 기록 조회)
- [x] `routes/payments.js` - **완료** (수납 CRUD, 일괄 청구, 납부 처리, 미납자 조회, 통계)
- [x] `routes/salaries.js` - 기본 구조만 (TODO)
- [x] `routes/seasons.js` - 기본 구조만 (TODO)
- [x] `routes/schedules.js` - 기본 구조만 (TODO)
- [x] `routes/settings.js` - 기본 구조만 (TODO)

### 4. 인증 시스템
- [x] **회원가입 API** (`POST /api/auth/register`)
  - 이메일/비밀번호 기반 회원가입
  - bcrypt 비밀번호 암호화
  - 개발자 승인 시스템 (approval_status: pending)
  - 원장 가입 시 학원 정보 자동 생성

- [x] **로그인 API** (`POST /api/auth/login`)
  - JWT 토큰 발급
  - 승인 상태 확인
  - 마지막 로그인 시간 기록

- [x] **JWT 미들웨어**
  - 토큰 검증
  - 사용자 정보 추출
  - 역할 기반 접근 제어 (requireRole)
  - 학원 접근 권한 확인 (checkAcademyAccess)

## 🚧 진행 중 / 대기 중

### 다음 단계 작업

#### 즉시 해야 할 작업
1. **MySQL 데이터베이스 테이블 생성**
   - MySQL Workbench에서 `database/salary_records_fix.sql` 실행
   - 모든 테이블이 정상적으로 생성되는지 확인

2. **백엔드 서버 테스트**
   ```bash
   cd backend
   npm install
   cp .env.example .env
   # .env 파일 수정 (JWT_SECRET 등)
   npm run dev
   ```
   - 서버가 http://localhost:8320 에서 정상 실행되는지 확인
   - 데이터베이스 연결 확인

3. **API 테스트** (Postman 또는 curl)
   - 회원가입 테스트
   - 로그인 테스트
   - JWT 토큰 발급 확인

#### 백엔드 API 구현 (우선순위 순)
1. **사용자 승인 시스템** (`routes/users.js`)
   - GET /api/users - 사용자 목록 조회 (관리자만)
   - POST /api/users/approve/:id - 사용자 승인 (원장만)
   - POST /api/users/reject/:id - 사용자 거부 (원장만)

2. **학생 관리 API** (`routes/students.js`)
   - CRUD 기능 구현
   - 프로필 사진 업로드
   - 학년 자동 승급 로직

3. **강사 관리 API** (`routes/instructors.js`)
   - CRUD 기능 구현
   - 출퇴근 기록 관리

4. **시즌 전환 로직** (`routes/seasons.js`) ⭐ **최고 난이도**
   - 시즌 생성/관리
   - 학생 시즌 등록
   - **일할 계산 엔진 구현**
   - 환불 계산 로직

5. **급여 계산 로직** (`routes/salaries.js`) ⭐
   - 4대보험 계산 함수 (`utils/calculator.js`)
   - 급여 자동 생성
   - 급여 명세서 출력

6. **수납 관리 API** (`routes/payments.js`)
   - 수강료 청구 생성
   - 미납자 자동 추출
   - 납부 처리

#### 프론트엔드 개발
- [ ] Next.js 프로젝트 초기화
- [ ] Tailwind CSS + shadcn/ui 설정
- [ ] 로그인/회원가입 페이지
- [ ] 대시보드
- [ ] 학생/강사 관리 페이지
- [ ] 수납/급여 관리 페이지
- [ ] 시즌 관리 페이지

#### 배포
- [ ] GitHub 레포지토리 생성
- [ ] 백엔드 서버 배포
- [ ] API 프록시 설정 (https://suepermax.kr/paca/)
- [ ] 프론트엔드 배포

## 📋 주요 결정 사항

### 1. 인증 방식
- ✅ **소셜 로그인 보류** → 우선 이메일/비밀번호 방식
- 추후 카카오톡, 네이버 OAuth 추가 가능 (확장성 고려됨)

### 2. 데이터베이스
- ✅ MySQL 예약어 문제 해결:
  - `3.3%` → `tax_3_3` (VARCHAR)
  - `year_month` → 백틱으로 감쌈 `` `year_month` ``
  - `check` → `cheque` 로 변경

### 3. 권한 시스템
- **owner** (원장): 모든 권한
- **admin** (관리자): 학원 내 관리 권한
- **teacher** (선생님): 제한된 조회 권한

### 4. 승인 시스템
- 회원가입 시 `approval_status = 'pending'`
- 개발자(owner)가 승인해야 로그인 가능
- `approved`, `rejected` 상태 관리

## 🔑 중요 정보

### 데이터베이스 접속 정보
```
Host: 211.37.174.218
Port: 3306
User: root
Password: Qq141171616!
Database: paca
```

### 서버 설정
```
Port: 8320
API Base: /api
CORS: * (모든 origin 허용)
JWT Expiry: 24h
```

### API Endpoint 구조
```
https://suepermax.kr/paca/api/...

/api/auth/register       - 회원가입
/api/auth/login          - 로그인
/api/auth/me             - 내 정보
/api/students            - 학생 관리
/api/instructors         - 강사 관리
/api/payments            - 수납 관리
/api/salaries            - 급여 관리
/api/seasons             - 시즌 관리
```

## 📚 참고 문서

- `docs/시즌전환로직분석.md` - 시즌 전환 로직 상세 설명
- `docs/i-max-4대보험분석.md` - 4대보험 계산 로직 (자동 생성됨)
- `backend/README.md` - 백엔드 설치 및 실행 가이드
- `database/schema-fixed.sql` - 최신 데이터베이스 스키마
- `체대입시학원관리시스템기획서.md` - 초기 기획서
- `p-aca.md` - 상세 기획서

## 🐛 알려진 이슈

1. ~~`year_month` 예약어 문제~~ ✅ 해결 (백틱 사용)
2. ~~`3.3%` ENUM 문제~~ ✅ 해결 (VARCHAR 'tax_3_3')
3. ~~`check` 예약어 문제~~ ✅ 해결 ('cheque'로 변경)

## 💡 다음 세션 시 체크리스트

### 백엔드 서버 시작 전
- [ ] MySQL 데이터베이스 테이블 생성 완료 확인
- [ ] `.env` 파일 설정 확인
- [ ] `npm install` 실행
- [ ] `npm run dev` 로 서버 시작
- [ ] http://localhost:8320/health 접속 확인

### API 테스트
- [ ] 회원가입 API 테스트
- [ ] 로그인 후 JWT 토큰 받기
- [ ] 토큰으로 `/api/auth/me` 호출 테스트

### 다음 구현할 기능
1. 사용자 승인 시스템 (원장이 pending 사용자 승인)
2. 학생 CRUD API
3. 시즌 전환 로직 (핵심 복잡 기능)

## 📈 진행률

- **사전 조사**: 100% ✅
- **데이터베이스 설계**: 100% ✅
- **백엔드 초기 구조**: 100% ✅
- **인증 시스템**: 100% ✅
- **학생 관리 API**: 0%
- **강사 관리 API**: 0%
- **시즌 전환 로직**: 0%
- **급여 계산 로직**: 0%
- **프론트엔드**: 0%

**전체 진행률: 약 25%**

---

## 🎯 최종 목표

완벽하게 작동하는 체대입시 학원관리시스템 구축:
- 복잡한 시즌 전환 로직 자동화
- 정확한 4대보험 계산
- 직관적인 UI/UX
- 안정적인 성능
- 확장 가능한 구조

**화이팅! 💪**
