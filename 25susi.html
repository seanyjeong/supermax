<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>맥스 25수시 모집요강</title>
<link rel="icon" type="image/gif" href="https://github.com/seanyjeong/max24liveM/blob/main/max.gif?raw=true">
<style>
  body.modal-open {
    overflow: hidden;
  }
  body {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  .fixed-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    background-color: white;
  }
  .fixed-header h1, .fixed-header .filter-container, .fixed-header .buttons {
    margin: 0;
    padding: 10px;
    background-color: white;
  }
  .fixed-header h1 {
    text-align: center;
    font-size: 24px; /* 원하는 폰트 사이즈로 변경 */
  }

  .table-container {
    padding: 0px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    margin: 0 ;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .buttons button {
    width: 120px; /* 원하는 너비로 설정 */
    height: 40px; /* 원하는 높이로 설정 */
    font-size: 13px; /* 글씨 크기 설정 */
    padding: 5px; /* 내부 여백 설정 */
    border-radius: 10px;
  }

  th, td {
    border: 1px solid black;
    padding: 8px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  th {
    background-color: #f2f2f2;
  }
  .filter-container {
    margin-bottom: 20px;
    text-align: left;
    position: relative;
    background-image: url('https://github.com/seanyjeong/supermax/blob/main/maxlogo%20(2).png?raw=true');
    background-size: cover;
    background-position: center;
    padding: 10px;
    border-radius: 10px;
  }
  .filter-title {
    font-weight: bold;
    margin-right: 10px;
    position: relative;
    z-index: 1;
  }
  .filter-box {
    display: inline-block;
    margin: 2px;
    padding: 5px;
    border: 1px solid #b4afaf;
    cursor: pointer;
    background-color: rgba(255, 255, 255, 0.8); /* 배경에 투명도 추가 */
    color: black;
    border-radius: 10px; /* 모서리를 둥글게 */
  }
  .filter-box.selected {
    background-color: #007bff;
    color: white;
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 1200px;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  .modal-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
  }
  .modal-table th {
    background-color: #5b6164;
    color: white;
  }
  .hidden {
    display: none;
  }
  button {
    margin-bottom: 10px;
  }
  .col-1, .col-2, .col-3 {
    width: 2%;
  }
  .col-4, .col-5 {
    width: 10%;
  }
  .col-6, .col-7, .col-8, .col-9 {
    width: 5%;
  }
  .col-10, .col-11 {
    width: auto;
  }
  .image-modal {
    width: 800px;
    max-width: 70%;
  }
  .modal img {
    max-width: 100%;
    height: auto;
  }

  /* 색상 클래스 추가 */
  .bg-category1 {
    background-color: #ff9999; /* 종류, 형태, 지역 */
  }

  .bg-category2 {
    background-color: #99ccff; /* 대학명, 학과명 */
  }

  .bg-category3 {
    background-color: #99ff99; /* 전형명, 모집인원, 교직 */
  }

  .bg-category4 {
    background-color: #ffcc99; /* 1단계배수, 내신, 실기, 면접, 기타, 수능최저 */
  }

  .bg-category5 {
    background-color: #cc99ff; /* 실기1~실기8 */
  }

  .search-container {
    text-align: center;
    margin: 5px 0;
  }

  .filter-title-practical {
    color: red; /* 빨간색으로 표시 */
  }
</style>
</head>
<body>
<div class="fixed-header">
  <h1 style="text-align: center;">맥스 25수시 모집요강</h1>
  <div class="filter-container" id="filter-container">
    <!-- 필터링 옵션 -->
  </div>
  <div class="buttons" style="text-align: center;">
    <button onclick="clearFilters()">필터초기화</button>
    <button onclick="applyFilter()">검색</button>
    <span id="filtered-count">선택된 학교 : 0개</span> <!-- 필터링된 행의 갯수를 표시할 요소 -->
  </div>
  <div class="search-container">
    <input type="text" id="search-input" placeholder="대학명을 입력하세요" style="width: 200px; padding: 5px;">
    <button onclick="searchByUniversity()">검색</button>
  </div>
  <table id="fixed-header-table">
    <thead id="table-head">
      <!-- 고정된 테이블 헤더 -->
    </thead>
  </table>
</div>

<div class="table-container" id="table-container">
  <table id="data-table">
    <thead>
      <!-- 동일한 헤더로 간주 -->
      <tr id="dummy-head" class="hidden">
        <!-- 헤더 컬럼은 이곳에 추가됩니다 -->
      </tr>
    </thead>
    <tbody id="table-body">
      <!-- 테이블 바디 -->
    </tbody>
  </table>
</div>

<!-- 모달 -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modal-body">
      <!-- 모달 내용 -->
    </div>
  </div>
</div>

<script>
  function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in.');
        window.location.href = 'index.html';
    }
  }

  let fullData = [];
  let filteredData = [];

  function fetchData() {
    const token = localStorage.getItem('token');
    fetch('https://supermax.kr/25susi', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      fullData = data;
      createFilterOptions(data, '종류');
      createFilterOptions(data, '형태');
      createFilterOptions(data, '지역');
      createFilterOptions(data, '교직');
      createPracticalFilterOptions(data);
      filteredData = fullData; // 초기 데이터 설정
      displayTable(data);
      adjustTableContainerMargin();
      updateFilteredCount(); // 필터링된 행의 갯수를 업데이트
    })
    .catch(error => console.error('데이터 가져오기 오류:', error));
  }

  function createFilterOptions(data, category) {
    const filterContainer = document.getElementById('filter-container');
    const uniqueValues = new Set(data.map(item => item[category]).filter(value => value));

    const title = document.createElement('span');
    title.textContent = category;
    title.className = 'filter-title';
    filterContainer.appendChild(title);

    uniqueValues.forEach(value => {
      const filterBox = document.createElement('div');
      filterBox.className = 'filter-box';
      filterBox.textContent = value;
      filterBox.dataset.category = category;
      filterBox.dataset.value = value;
      filterBox.onclick = () => filterBox.classList.toggle('selected');
      filterContainer.appendChild(filterBox);
    });
    filterContainer.appendChild(document.createElement('br'));
  }

  function createPracticalFilterOptions(data) {
    const filterContainer = document.getElementById('filter-container');

    const title = document.createElement('span');
    title.textContent = '실기제외';
    title.className = 'filter-title filter-title-practical'; /* 필터 제목에 클래스 추가 */
    filterContainer.appendChild(title);

    const practicalValues = ['제멀', '메던', '배근력', '좌전굴', '체전굴', '20m', '싯업'];
    const practicalFields = ['실기1', '실기2', '실기3', '실기4', '실기5', '실기6', '실기7', '실기8'];

    practicalValues.forEach(value => {
      const filterBox = document.createElement('div');
      filterBox.className = 'filter-box';
      filterBox.textContent = value;
      filterBox.dataset.category = '실기';
      filterBox.dataset.value = value;
      filterBox.onclick = () => filterBox.classList.toggle('selected');
      filterContainer.appendChild(filterBox);
    });

    filterContainer.appendChild(document.createElement('br'));
  }

  function applyFilter() {
    const selectedFilters = {};
    document.querySelectorAll('.filter-box.selected').forEach(box => {
      const category = box.dataset.category;
      const value = box.dataset.value;
      if (!selectedFilters[category]) {
        selectedFilters[category] = [];
      }
      selectedFilters[category].push(value);
    });

    const practicalFields = ['실기1', '실기2', '실기3', '실기4', '실기5', '실기6', '실기7', '실기8'];

    filteredData = fullData.filter(item => {
      const passesFilter = Object.keys(selectedFilters).every(category => {
        if (category === '실기') {
          return !selectedFilters[category].some(value => 
            practicalFields.some(field => item[field] === value)
          );
        }
        return selectedFilters[category].length === 0 || selectedFilters[category].includes(item[category]);
      });
      return passesFilter;
    });

    displayTable(filteredData);
    updateFilteredCount(); // 필터링된 행의 갯수를 업데이트
  }

  function clearFilters() {
    document.querySelectorAll('.filter-box.selected').forEach(box => box.classList.remove('selected'));
    document.getElementById('search-input').value = ''; // 검색창 초기화
    filteredData = fullData;
    displayTable(filteredData);
    updateFilteredCount(); // 필터 초기화 후 갯수 업데이트
  }

  function displayTable(data) {
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    const dummyHead = document.getElementById('dummy-head');

    tableHead.innerHTML = '';
    dummyHead.innerHTML = '';

    if (data.length > 0) {
      const headers = Object.keys(data[0]).filter(header => header !== 'id');
      const trHead = document.createElement('tr');
      const trDummy = document.createElement('tr');

      headers.filter((header, index) => 
        [1, 2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14, 15, 16, 43, 44, 45, 46, 47, 48, 49, 50].includes(index)
      ).forEach((header, index) => {
        const th = document.createElement('th');
        const thDummy = document.createElement('th');
        th.textContent = header;
        thDummy.textContent = header;

        if (['종류', '형태', '지역'].includes(header)) {
          th.classList.add('bg-category1');
          thDummy.classList.add('bg-category1');
        } else if (['대학명', '학과명'].includes(header)) {
          th.classList.add('bg-category2');
          thDummy.classList.add('bg-category2');
        } else if (['전형명', '모집정원', '교직'].includes(header)) {
          th.classList.add('bg-category3');
          thDummy.classList.add('bg-category3');
        } else if (['1단계배수', '내신', '실기', '면접', '기타', '수능최저'].includes(header)) {
          th.classList.add('bg-category4');
          thDummy.classList.add('bg-category4');
        } else if (['실기1', '실기2', '실기3', '실기4', '실기5', '실기6', '실기7', '실기8'].includes(header)) {
          th.classList.add('bg-category5');
          thDummy.classList.add('bg-category5');
        }

        if (index < 3) {
          th.classList.add('col-1');
          thDummy.classList.add('col-1');
        } else if (index < 5) {
          th.classList.add('col-4');
          thDummy.classList.add('col-4');
        } else if (index >= 43 && index <= 50) {
          th.classList.add('col-6');
          thDummy.classList.add('col-6');
        } else {
          th.classList.add('col-10');
          thDummy.classList.add('col-10');
        }
        trHead.appendChild(th);
        trDummy.appendChild(thDummy);
      });

      tableHead.appendChild(trHead);
      dummyHead.appendChild(trDummy);
    }

    tableBody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.onclick = () => showModal(row);
      Object.keys(row).filter((key, index) => 
        key !== 'id' && [1, 2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14, 15, 16, 43, 44, 45, 46, 47, 48, 49, 50].includes(index)
      ).forEach((key, index) => {
        const td = document.createElement('td');
        td.textContent = row[key];
        if (index < 3) {
          td.classList.add('col-1');
        } else if (index < 5) {
          td.classList.add('col-4');
        } else if (index >= 43 && index <= 50) {
          td.classList.add('col-6');
        } else {
          td.classList.add('col-10');
        }
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });

    adjustHeaderFontSize(); // 테이블 갱신 후 글씨 크기 조정
  }

  function showModal(data) {
    const modal = document.getElementById('myModal');
    const modalContent = document.querySelector('.modal-content');
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = '';

    const title = document.createElement('div');
    title.className = 'modal-title';
    title.textContent = `${data['대학명']} - ${data['학과명']}`;
    modalBody.appendChild(title);

    if (data['image_data']) {
      const img = document.createElement('img');
      img.src = `data:image/png;base64,${data['image_data']}`;
      img.alt = '이미지 불러오기 실패';
      modalBody.appendChild(img);
      modalContent.classList.add('image-modal');
    } else {
      const table = document.createElement('table');
      table.className = 'modal-table';

      const rows = [
        ['종류', '형태', '지역'],
        ['전형명', '모집정원', '교직', '1단계배수', '1단계학생부', '1단계기타'],
        ['내신', '실기', '면접', '기타', '수능최저'],
        ['내신반영'],
        ['1학년', '2학년', '3학년', 'n반영', '교과', '출결', '기타', '교과_일반', '교과진로'],
        ['과목반영'],
        ['국', '수', '영', '사', '과', '기타_[1]'],
        ['등급별점수'],
        ['1등급', '2등급', '3등급', '4등급', '5등급', '6등급', '7등급', '8등급', '9등급'],
        ['실기1', '실기2', '실기3', '실기4', '실기5', '실기6', '실기7', '실기8'],
        ['1단계발표', '실기날짜', '합격자발표'],
        ['전년도'],
        ['정원', '지원자', '추가합격', '입시결과', '경쟁률']
      ];

      rows.forEach((row, rowIndex) => {
        const trTitle = document.createElement('tr');
        const trValue = document.createElement('tr');
        if (rowIndex === 3 || rowIndex === 5 || rowIndex === 7 || rowIndex === 11) {
          const thTitle = document.createElement('th');
          thTitle.colSpan = row.length;
          thTitle.textContent = row[0];
          trTitle.appendChild(thTitle);
        } else {
          row.forEach(cell => {
            const th = document.createElement('th');
            th.textContent = cell;
            trTitle.appendChild(th);

            const td = document.createElement('td');
            td.textContent = data[cell] || '';
            trValue.appendChild(td);
          });
        }
        table.appendChild(trTitle);
        table.appendChild(trValue);
      });

      modalBody.appendChild(table);
      modalContent.classList.remove('image-modal');
    }
    modal.style.display = 'block';
    document.body.classList.add('modal-open');
  }

  function closeModal() {
    const modal = document.getElementById('myModal');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
  }

  function adjustTableContainerMargin() {
    const fixedHeader = document.querySelector('.fixed-header');
    const tableContainer = document.getElementById('table-container');
    const headerHeight = fixedHeader.offsetHeight;
    tableContainer.style.marginTop = `${headerHeight}px`;
  }

  function searchByUniversity() {
    const searchInput = document.getElementById('search-input').value.trim().toLowerCase();
    if (searchInput) {
      filteredData = fullData.filter(item => item['대학명'].toLowerCase().includes(searchInput));
    } else {
      filteredData = fullData;
    }
    displayTable(filteredData);
    updateFilteredCount(); // 필터링된 행의 갯수를 업데이트
  }

  function updateFilteredCount() {
    const filteredCount = filteredData.length;
    const filteredCountElement = document.getElementById('filtered-count');
    filteredCountElement.textContent = `선택된 학교 : ${filteredCount}개`;
  }

  function adjustHeaderFontSize() {
    const headers = document.querySelectorAll('#table-head th');
    headers.forEach(header => {
      let fontSize = 16; // 기본 글씨 크기
      header.style.fontSize = fontSize + 'px';
      while (header.scrollWidth > header.clientWidth && fontSize > 10) { // 줄어드는 글씨 크기 제한 설정
        fontSize -= 1;
        header.style.fontSize = fontSize + 'px';
      }
    });
  }

  document.getElementById('search-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      searchByUniversity();
    }
  });

  document.querySelector('.close').onclick = closeModal;
  window.onclick = function(event) {
    const modal = document.getElementById('myModal');
    if (event.target == modal) {
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
  }

  window.onresize = adjustTableContainerMargin;
  document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    fetchData();
    adjustTableContainerMargin();
  });
</script>
</body>
<footer style="margin-top: 3rem; text-align: center;">
  <p>© 2024 맥스체대입시 일산교육원. All rights reserved.</p>
</footer>
</html>
