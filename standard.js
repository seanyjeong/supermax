module.exports = function(input, rows, ìµœê³ ì Map) {
  console.log('ğŸ“Œ ìµœê³ ì Map:', ìµœê³ ì Map); // ìµœê³ ì  í…Œì´ë¸” í™•ì¸
  console.log('ğŸ“¥ ì…ë ¥ê°’:', input); // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì ìˆ˜, ê³¼ëª©ëª… í™•ì¸

  const ê³¼íƒëª©ë¡ = ["ë¬¼ë¦¬1", "ë¬¼ë¦¬2", "í™”í•™1", "í™”í•™2", "ìƒëª…ê³¼í•™1", "ìƒëª…ê³¼í•™2", "ì§€êµ¬ê³¼í•™1", "ì§€êµ¬ê³¼í•™2"];

function getConvertedScore(stdScore, subjectName, ê¸°ì¤€) {
  if (subjectName === 'ì˜ì–´') {
    if (ê¸°ì¤€ === 'ìµœê³ ì ') {
      const ìµœê³ ì  = ìµœê³ ì Map['ì˜ì–´1ë“±ê¸‰ì ìˆ˜'];
      return ìµœê³ ì  ? stdScore / ìµœê³ ì  : 0;
    } else if (ê¸°ì¤€ === '200') {
      return stdScore / 200;
    }
  }

  const ìµœê³ ì  = ìµœê³ ì Map[subjectName.trim()]; // âœ… ì—¬ê¸°!
  if (ê¸°ì¤€ === 'ìµœê³ ì ') return ìµœê³ ì  ? stdScore / ìµœê³ ì  : 0;
  if (ê¸°ì¤€ === '200') return stdScore / 200;

  return 0;
}

  console.log('ğŸ§¾ ê³¼ëª©ëª…:', {
    êµ­ì–´ê³¼ëª©: input.koreanSubject,
    ìˆ˜í•™ê³¼ëª©: input.mathSubject,
    íƒêµ¬1ê³¼ëª©: input.subject1Name,
    íƒêµ¬2ê³¼ëª©: input.subject2Name
  });
  

  const results = rows.map(row => {
    const ì˜ì–´ë“±ê¸‰ì ìˆ˜ = row[`ì˜ì–´${input.englishGrade}ë“±ê¸‰ì ìˆ˜`] || 0;
    const í•œêµ­ì‚¬ë“±ê¸‰ì ìˆ˜ = row[`í•œêµ­ì‚¬${input.khistoryGrade}ë“±ê¸‰ì ìˆ˜`] || 0;

    let ìˆ˜í•™ì ìˆ˜ = input.math_std;
    let íƒêµ¬1ì ìˆ˜ = input.subject1_std;
    let íƒêµ¬2ì ìˆ˜ = input.subject2_std;

    // ìˆ˜í•™ ê°€ì‚°ì 
    if (row.ìˆ˜í•™ê°€ì‚°ê³¼ëª©ì¡°ê±´) {
      row.ìˆ˜í•™ê°€ì‚°ê³¼ëª©ì¡°ê±´.split(',').forEach(ì¡°ê±´ => {
        const [ê³¼ëª©, í¼ì„¼íŠ¸] = ì¡°ê±´.split(':');
        if (input.mathSubject === ê³¼ëª©.trim()) {
          ìˆ˜í•™ì ìˆ˜ *= 1 + (parseFloat(í¼ì„¼íŠ¸ || 0) / 100);
        }
      });
    }

    // íƒêµ¬ ê°€ì‚°ì 
    if (typeof row.íƒêµ¬ê°€ì‚°ê³¼ëª©ì¡°ê±´ === 'string' && row.íƒêµ¬ê°€ì‚°ê³¼ëª©ì¡°ê±´.includes('ê³¼íƒ')) {
      const ê°€ì‚° = parseFloat(row.íƒêµ¬ê°€ì‚°ê³¼ëª©ì¡°ê±´.split(':')[1]) || 0;
      if (ê³¼íƒëª©ë¡.includes(input.subject1Name)) íƒêµ¬1ì ìˆ˜ *= (1 + ê°€ì‚° / 100);
      if (ê³¼íƒëª©ë¡.includes(input.subject2Name)) íƒêµ¬2ì ìˆ˜ *= (1 + ê°€ì‚° / 100);
    }

    // íƒêµ¬ ê³„ì‚°
    let íƒêµ¬ = row.íƒêµ¬ê³¼ëª©ìˆ˜ === 2 ? (íƒêµ¬1ì ìˆ˜ + íƒêµ¬2ì ìˆ˜) / 2 : Math.max(íƒêµ¬1ì ìˆ˜, íƒêµ¬2ì ìˆ˜);

    // ê¸°ì¤€
    const ê¸°ì¤€ = row.í‘œì¤€ì ìˆ˜ë§Œì ;

    const êµ­ì–´í™˜ì‚° = getConvertedScore(input.korean_std, input.koreanSubject, ê¸°ì¤€);
    const ìˆ˜í•™í™˜ì‚° = getConvertedScore(ìˆ˜í•™ì ìˆ˜, input.mathSubject, ê¸°ì¤€);
    const íƒêµ¬í™˜ì‚° = getConvertedScore(íƒêµ¬, 'íƒêµ¬', ê¸°ì¤€);

    const êµ­ì–´ì ìˆ˜ = êµ­ì–´í™˜ì‚° * (row.êµ­ì–´ë¹„ìœ¨ / 100);
    const ìˆ˜í•™ì ìˆ˜_ê°€ì‚° = ìˆ˜í•™í™˜ì‚° * (row.ìˆ˜í•™ë¹„ìœ¨ / 100);

    let ì˜ì–´ì ìˆ˜ = 0;
    if (row.ì˜ì–´ë¹„ìœ¨ === 'ê°ì ') {
      ì˜ì–´ì ìˆ˜ = ì˜ì–´ë“±ê¸‰ì ìˆ˜;
    } else if (typeof row.ì˜ì–´ë¹„ìœ¨ === 'number' || !isNaN(parseFloat(row.ì˜ì–´ë¹„ìœ¨))) {
      ì˜ì–´ì ìˆ˜ = ì˜ì–´ë“±ê¸‰ì ìˆ˜ * (parseFloat(row.ì˜ì–´ë¹„ìœ¨) / 100);
    }

    const íƒêµ¬ì ìˆ˜ = íƒêµ¬í™˜ì‚° * (row.íƒêµ¬ë¹„ìœ¨ / 100);

    let ì„ íƒì ìˆ˜ = 0;
    let ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ = 0;

    if (!row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ || row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´.trim() === '') {
      ì„ íƒì ìˆ˜ = êµ­ì–´ì ìˆ˜ + ìˆ˜í•™ì ìˆ˜_ê°€ì‚° + ì˜ì–´ì ìˆ˜;
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ = (ì„ íƒì ìˆ˜ + íƒêµ¬ì ìˆ˜) * (row.ìˆ˜ëŠ¥ë°˜ì˜ë¹„ìœ¨ / 100);
    } else if (row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ === 'êµ­ìˆ˜ì˜íƒ2') {
      const candidates = [
        { ê³¼ëª©: 'êµ­ì–´', ì ìˆ˜: êµ­ì–´ì ìˆ˜ },
        { ê³¼ëª©: 'ìˆ˜í•™', ì ìˆ˜: ìˆ˜í•™ì ìˆ˜_ê°€ì‚° },
        { ê³¼ëª©: 'ì˜ì–´', ì ìˆ˜: ì˜ì–´ì ìˆ˜ }
      ];
    
      candidates.sort((a, b) => b.ì ìˆ˜ - a.ì ìˆ˜);
      const top2 = candidates.slice(0, 2);
    
      console.log('ğŸ¯ ì„ íƒê³¼ëª© Top2:', top2);
    
      ì„ íƒì ìˆ˜ = top2.reduce((acc, cur) => acc + cur.ì ìˆ˜, 0);
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ = (ì„ íƒì ìˆ˜ + íƒêµ¬ì ìˆ˜) * (row.ìˆ˜ëŠ¥ë°˜ì˜ë¹„ìœ¨ / 100);
    }
    if (row.í•œêµ­ì‚¬ë°˜ì˜ë°©ì‹ === 'ê°€ì‚°ì ') ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ += í•œêµ­ì‚¬ë“±ê¸‰ì ìˆ˜;
    if (row.ì˜ì–´ë¹„ìœ¨ === 'ê°ì ') ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ += ì˜ì–´ë“±ê¸‰ì ìˆ˜;

    // âœ… ê°œë³„ ë””ë²„ê¹… ì¶œë ¥
    console.log(`ğŸ¯ [${row.ëŒ€í•™ëª…}] ì´ì ê³„ì‚° â†’ êµ­ì–´:${êµ­ì–´ì ìˆ˜}, ìˆ˜í•™:${ìˆ˜í•™ì ìˆ˜_ê°€ì‚°}, ì˜ì–´:${ì˜ì–´ì ìˆ˜}, íƒêµ¬:${íƒêµ¬ì ìˆ˜}, ìµœì¢…:${ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜}`);
    console.log('ğŸ“Œ ëŒ€í•™:', row.ëŒ€í•™ëª…, row.í•™ê³¼ëª…);
    console.log('ğŸ“Š ì…ë ¥ ê³¼ëª©:', {
      êµ­ì–´ê³¼ëª©: input.koreanSubject,
      ìˆ˜í•™ê³¼ëª©: input.mathSubject,
      íƒêµ¬1ê³¼ëª©: input.subject1Name,
      íƒêµ¬2ê³¼ëª©: input.subject2Name
    });
    console.log('ğŸ“Š ì…ë ¥ ì ìˆ˜:', {
      êµ­ì–´: input.korean_std,
      ìˆ˜í•™: input.math_std,
      íƒêµ¬1: input.subject1_std,
      íƒêµ¬2: input.subject2_std,
      ì˜ì–´ë“±ê¸‰: input.englishGrade,
      ì˜ì–´ë“±ê¸‰ì ìˆ˜: ì˜ì–´ë“±ê¸‰ì ìˆ˜
    });
    console.log('ğŸ“ ë³€í™˜ ì ìˆ˜:', {
      êµ­ì–´í™˜ì‚°: êµ­ì–´í™˜ì‚°,
      ìˆ˜í•™í™˜ì‚°: ìˆ˜í•™í™˜ì‚°,
      íƒêµ¬í™˜ì‚°: íƒêµ¬í™˜ì‚°,
      ì˜ì–´: ì˜ì–´ì ìˆ˜
    });
    console.log('âš™ï¸ ë°˜ì˜ë¹„ìœ¨:', {
      êµ­ì–´ë¹„ìœ¨: row.êµ­ì–´ë¹„ìœ¨,
      ìˆ˜í•™ë¹„ìœ¨: row.ìˆ˜í•™ë¹„ìœ¨,
      ì˜ì–´ë¹„ìœ¨: row.ì˜ì–´ë¹„ìœ¨,
      íƒêµ¬ë¹„ìœ¨: row.íƒêµ¬ë¹„ìœ¨,
      ìˆ˜ëŠ¥ë°˜ì˜ë¹„ìœ¨: row.ìˆ˜ëŠ¥ë°˜ì˜ë¹„ìœ¨
    });
    console.log('ğŸ§  ìˆ˜ëŠ¥ì„ íƒì¡°ê±´:', row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ || 'ê¸°ë³¸');
    console.log('ğŸ§® ê³¼ëª©ë³„ ì ìˆ˜:', {
      êµ­ì–´ì ìˆ˜,
      ìˆ˜í•™ì ìˆ˜_ê°€ì‚°,
      ì˜ì–´ì ìˆ˜,
      íƒêµ¬ì ìˆ˜
    });
    console.log('âœ… ì„ íƒì ìˆ˜:', ì„ íƒì ìˆ˜, '/ ìµœì¢… ìˆ˜ëŠ¥í•©ì‚°ì ìˆ˜:', ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜);
    console.log('----------------------------------------------');
    
    return {
      ëŒ€í•™ëª…: row.ëŒ€í•™ëª…,
      í•™ê³¼ëª…: row.í•™ê³¼ëª…,
      ìµœì¢…í•©ì‚°ì ìˆ˜: Math.round(ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ * 10) / 10,
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜: Math.round(ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ * 10) / 10,
      ì„ íƒì ìˆ˜: Math.round(ì„ íƒì ìˆ˜ * 10) / 10,
      ê³„ì‚°ê¸°ì¤€: 'í‘œì¤€ì ìˆ˜',
      ë°˜ì˜ì§€í‘œ: row.ë°˜ì˜ì§€í‘œ || 'í‘œ/í‘œ',
      ìˆ˜ëŠ¥ì„ íƒì¡°ê±´: row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ || '',
      êµ­ì–´: input.korean_std,
      ìˆ˜í•™: input.math_std,
      ì˜ì–´: Math.round(ì˜ì–´ì ìˆ˜ * 10) / 10,
      íƒêµ¬: Math.round(íƒêµ¬ * 10) / 10,
      êµ­ì–´ë¹„ìœ¨: row.êµ­ì–´ë¹„ìœ¨ || 0,
      ìˆ˜í•™ë¹„ìœ¨: row.ìˆ˜í•™ë¹„ìœ¨ || 0,
      ì˜ì–´ë¹„ìœ¨: row.ì˜ì–´ë¹„ìœ¨ || 0,
      íƒêµ¬ë¹„ìœ¨: row.íƒêµ¬ë¹„ìœ¨ || 0,
      ì˜ì–´ë“±ê¸‰: input.englishGrade,
      í•œêµ­ì‚¬ë“±ê¸‰: input.khistoryGrade,
      íƒêµ¬ê³¼ëª©ìˆ˜: row.íƒêµ¬ê³¼ëª©ìˆ˜ || 0,
      í•œêµ­ì‚¬ë°˜ì˜ë°©ì‹: row.í•œêµ­ì‚¬ë°˜ì˜ë°©ì‹ || ''
    };
  }).filter(Boolean);

  results.sort((a, b) => b.ìµœì¢…í•©ì‚°ì ìˆ˜ - a.ìµœì¢…í•©ì‚°ì ìˆ˜);
  return results;
};
