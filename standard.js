module.exports = function(input, rows, ìµœê³ ì Map) {
  console.log('ğŸ“Œ ìµœê³ ì Map:', ìµœê³ ì Map);

  const ê³¼íƒëª©ë¡ = ["ë¬¼ë¦¬1", "ë¬¼ë¦¬2", "í™”í•™1", "í™”í•™2", "ìƒëª…ê³¼í•™1", "ìƒëª…ê³¼í•™2", "ì§€êµ¬ê³¼í•™1", "ì§€êµ¬ê³¼í•™2"];

  function getConvertedScore(stdScore, subjectName, ê¸°ì¤€) {
    if (subjectName === 'ì˜ì–´') {
      if (ê¸°ì¤€ === 'ìµœê³ ì ') {
        const ìµœê³ ì  = ìµœê³ ì Map['ì˜ì–´1ë“±ê¸‰ì ìˆ˜'];
        return ìµœê³ ì  ? stdScore / ìµœê³ ì  : 0;
      } else if (ê¸°ì¤€ === '200') {
        return stdScore / 200;
      }
    }

    const ìµœê³ ì  = ìµœê³ ì Map[subjectName];
    if (ê¸°ì¤€ === 'ìµœê³ ì ') return ìµœê³ ì  ? stdScore / ìµœê³ ì  : 0;
    if (ê¸°ì¤€ === '200') return stdScore / 200;
    return 0;
  }

  const results = rows.map(row => {
    const ì˜ì–´ë“±ê¸‰ì ìˆ˜ = row[`ì˜ì–´${input.englishGrade}ë“±ê¸‰ì ìˆ˜`] || 0;
    const í•œêµ­ì‚¬ë“±ê¸‰ì ìˆ˜ = row[`í•œêµ­ì‚¬${input.khistoryGrade}ë“±ê¸‰ì ìˆ˜`] || 0;

    let ìˆ˜í•™ì ìˆ˜ = input.math_std;
    let íƒêµ¬1ì ìˆ˜ = input.subject1_std;
    let íƒêµ¬2ì ìˆ˜ = input.subject2_std;

    if (row.ìˆ˜í•™ê°€ì‚°ê³¼ëª©ì¡°ê±´) {
      const ì¡°ê±´ë“¤ = row.ìˆ˜í•™ê°€ì‚°ê³¼ëª©ì¡°ê±´.split(',');
      ì¡°ê±´ë“¤.forEach(ì¡°ê±´ => {
        const [ê³¼ëª©, í¼ì„¼íŠ¸] = ì¡°ê±´.split(':');
        if (input.mathSubject === ê³¼ëª©.trim()) {
          ìˆ˜í•™ì ìˆ˜ *= (1 + parseFloat(í¼ì„¼íŠ¸ || 0) / 100);
        }
      });
    }

    if (typeof row.íƒêµ¬ê°€ì‚°ê³¼ëª©ì¡°ê±´ === 'string' && row.íƒêµ¬ê°€ì‚°ê³¼ëª©ì¡°ê±´.includes('ê³¼íƒ')) {
      const parts = row.íƒêµ¬ê°€ì‚°ê³¼ëª©ì¡°ê±´.split(':');
      const ê°€ì‚° = parseFloat(parts[1]) || 0;
      if (ê³¼íƒëª©ë¡.includes(input.subject1Name)) íƒêµ¬1ì ìˆ˜ *= (1 + ê°€ì‚° / 100);
      if (ê³¼íƒëª©ë¡.includes(input.subject2Name)) íƒêµ¬2ì ìˆ˜ *= (1 + ê°€ì‚° / 100);
    }

    let íƒêµ¬ = 0;
    if (row.íƒêµ¬ê³¼ëª©ìˆ˜ === 2) íƒêµ¬ = (íƒêµ¬1ì ìˆ˜ + íƒêµ¬2ì ìˆ˜) / 2;
    else if (row.íƒêµ¬ê³¼ëª©ìˆ˜ === 1) íƒêµ¬ = Math.max(íƒêµ¬1ì ìˆ˜, íƒêµ¬2ì ìˆ˜);

    const ê¸°ì¤€ = row.í‘œì¤€ì ìˆ˜ë§Œì ;

    // íƒêµ¬ ìµœê³ ì  ê³„ì‚° ì§ì ‘
    const íƒêµ¬ìµœê³ ì 1 = ìµœê³ ì Map[input.subject1Name.trim()] || 0;
    const íƒêµ¬ìµœê³ ì 2 = ìµœê³ ì Map[input.subject2Name.trim()] || 0;
    let íƒêµ¬ìµœê³ ì  = 0;
    if (row.íƒêµ¬ê³¼ëª©ìˆ˜ === 2) íƒêµ¬ìµœê³ ì  = (íƒêµ¬ìµœê³ ì 1 + íƒêµ¬ìµœê³ ì 2) / 2;
    else if (row.íƒêµ¬ê³¼ëª©ìˆ˜ === 1) íƒêµ¬ìµœê³ ì  = Math.max(íƒêµ¬ìµœê³ ì 1, íƒêµ¬ìµœê³ ì 2);

    const êµ­ì–´í™˜ì‚° = getConvertedScore(input.korean_std, input.koreanSubject, ê¸°ì¤€);
    const ìˆ˜í•™í™˜ì‚° = getConvertedScore(ìˆ˜í•™ì ìˆ˜, input.mathSubject, ê¸°ì¤€);
    const íƒêµ¬í™˜ì‚° = ê¸°ì¤€ === 'ìµœê³ ì '
      ? íƒêµ¬ìµœê³ ì  ? íƒêµ¬ / íƒêµ¬ìµœê³ ì  : 0
      : ê¸°ì¤€ === '200'
      ? íƒêµ¬ / 200
      : 0;

    const êµ­ì–´ì ìˆ˜ = êµ­ì–´í™˜ì‚° * (row.êµ­ì–´ë¹„ìœ¨ / 100);
    const ìˆ˜í•™ì ìˆ˜_ê°€ì‚° = ìˆ˜í•™í™˜ì‚° * (row.ìˆ˜í•™ë¹„ìœ¨ / 100);

    let ì˜ì–´ì ìˆ˜ = 0;
    if (row.ì˜ì–´ë¹„ìœ¨ === 'ê°ì ') {
      ì˜ì–´ì ìˆ˜ = ì˜ì–´ë“±ê¸‰ì ìˆ˜;
    } else if (!isNaN(parseFloat(row.ì˜ì–´ë¹„ìœ¨))) {
      ì˜ì–´ì ìˆ˜ = ì˜ì–´ë“±ê¸‰ì ìˆ˜ * (parseFloat(row.ì˜ì–´ë¹„ìœ¨) / 100);
    }

    const íƒêµ¬ì ìˆ˜ = íƒêµ¬í™˜ì‚° * (row.íƒêµ¬ë¹„ìœ¨ / 100);

    let ì„ íƒì ìˆ˜ = 0;
    let ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ = 0;

    if (!row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ || row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´.trim() === '') {
      ì„ íƒì ìˆ˜ = êµ­ì–´ì ìˆ˜ + ìˆ˜í•™ì ìˆ˜_ê°€ì‚° + ì˜ì–´ì ìˆ˜;
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ = (ì„ íƒì ìˆ˜ + íƒêµ¬ì ìˆ˜) * (row.ìˆ˜ëŠ¥ë°˜ì˜ë¹„ìœ¨ / 100);
    } else if (row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ === 'êµ­ìˆ˜ì˜íƒ2') {
      const candidates = [
        { ì ìˆ˜: êµ­ì–´ì ìˆ˜ },
        { ì ìˆ˜: ìˆ˜í•™ì ìˆ˜_ê°€ì‚° },
        { ì ìˆ˜: ì˜ì–´ì ìˆ˜ }
      ];
      candidates.sort((a, b) => b.ì ìˆ˜ - a.ì ìˆ˜);
      const top2 = candidates.slice(0, 2);
      ì„ íƒì ìˆ˜ = top2.reduce((acc, cur) => acc + cur.ì ìˆ˜, 0);
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ = (ì„ íƒì ìˆ˜ + íƒêµ¬ì ìˆ˜) * (row.ìˆ˜ëŠ¥ë°˜ì˜ë¹„ìœ¨ / 100);
    }

    if (row.í•œêµ­ì‚¬ë°˜ì˜ë°©ì‹ === 'ê°€ì‚°ì ') {
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ += í•œêµ­ì‚¬ë“±ê¸‰ì ìˆ˜;
    }
    if (row.ì˜ì–´ë¹„ìœ¨ === 'ê°ì ') {
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ += ì˜ì–´ë“±ê¸‰ì ìˆ˜;
    }

    return {
      ëŒ€í•™ëª…: row.ëŒ€í•™ëª…,
      í•™ê³¼ëª…: row.í•™ê³¼ëª…,
      ìµœì¢…í•©ì‚°ì ìˆ˜: Math.round(ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ * 10) / 10,
      ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜: Math.round(ìˆ˜ëŠ¥ìµœì¢…ë°˜ì˜ì ìˆ˜ * 10) / 10,
      ì„ íƒì ìˆ˜: Math.round(ì„ íƒì ìˆ˜ * 10) / 10,
      ê³„ì‚°ê¸°ì¤€: 'í‘œì¤€ì ìˆ˜',
      ë°˜ì˜ì§€í‘œ: row.ë°˜ì˜ì§€í‘œ || 'í‘œ/í‘œ',
      ìˆ˜ëŠ¥ì„ íƒì¡°ê±´: row.ìˆ˜ëŠ¥ì„ íƒì¡°ê±´ || '',
      êµ­ì–´: input.korean_std,
      ìˆ˜í•™: input.math_std,
      ì˜ì–´: Math.round(ì˜ì–´ì ìˆ˜ * 10) / 10,
      íƒêµ¬: Math.round(íƒêµ¬ * 10) / 10,
      êµ­ì–´ë¹„ìœ¨: row.êµ­ì–´ë¹„ìœ¨ || 0,
      ìˆ˜í•™ë¹„ìœ¨: row.ìˆ˜í•™ë¹„ìœ¨ || 0,
      ì˜ì–´ë¹„ìœ¨: row.ì˜ì–´ë¹„ìœ¨ || 0,
      íƒêµ¬ë¹„ìœ¨: row.íƒêµ¬ë¹„ìœ¨ || 0,
      ì˜ì–´ë“±ê¸‰: input.englishGrade,
      í•œêµ­ì‚¬ë“±ê¸‰: input.khistoryGrade,
      íƒêµ¬ê³¼ëª©ìˆ˜: row.íƒêµ¬ê³¼ëª©ìˆ˜ || 0,
      í•œêµ­ì‚¬ë°˜ì˜ë°©ì‹: row.í•œêµ­ì‚¬ë°˜ì˜ë°©ì‹ || ''
    };
  }).filter(Boolean);

  results.sort((a, b) => b.ìµœì¢…í•©ì‚°ì ìˆ˜ - a.ìµœì¢…í•©ì‚°ì ìˆ˜);
  return results;
};
